<!DOCTYPE html>
<html>
<head>
    <title>SECR - Electrical (OP) Raipur</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background: #eaeff2; }
        
        /* Header Style */
        #main-header {
            position: absolute; top: 0; left: 0; width: 100%; background: white;
            display: none; align-items: center; padding: 5px 15px;
            border-bottom: 3px solid #002f6c; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Login Box Style */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; display: flex; align-items: center; justify-content: center;
        }
        .login-card { background: white; padding: 30px; border-radius: 10px; width: 350px; text-align: center; }
        .login-card input { width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .login-card button { width: 96%; background: #002f6c; color: white; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Upload Panel */
        #upload-panel {
            position: absolute; bottom: 30px; left: 30px; background: white;
            padding: 15px; border-radius: 8px; z-index: 2000; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-left: 5px solid #002f6c;
        }

        /* LC Barrier Icon */
        .lc-barrier { border-bottom: 3px solid black; border-left: 5px solid #333; height: 10px; width: 20px; background: repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 4px); }
    </style>
</head>
<body>

<div id="main-header">
    <img src="ir_logo.png" style="height:50px; margin-right:15px;" onerror="this.style.display='none'">
    <div style="flex-grow:1;">
        <div style="font-size:18px; font-weight:bold; color:#002f6c;">SOUTH EAST CENTRAL RAILWAY</div>
        <div style="font-size:12px; font-weight:bold; color:#d93025;">ELECTRICAL (OP) DEPARTMENT, RAIPUR</div>
    </div>
    <div style="text-align:right; font-weight:bold; padding-right:25px;">
        <div style="font-size:9px; color:#666;">LOGGED IN AS:</div>
        <div id="userDisplay" style="color:#002f6c; font-size:14px;">-</div>
    </div>
</div>

<div id="login-overlay">
    <div class="login-card">
        <h2 style="color:#002f6c; margin-bottom:5px;">SEC RAILWAY</h2>
        <p style="font-size:12px; color:#666; margin-bottom:20px;">Safety Audit Management System</p>
        <input type="text" id="uid" placeholder="Enter CLI ID / Admin Name">
        <input type="password" id="upass" placeholder="Password">
        <button onclick="attemptLogin()">SIGN IN</button>
        <div id="loginErr" style="color:red; font-size:12px; margin-top:10px;"></div>
    </div>
</div>

<div id="upload-panel">
    <div style="font-weight:bold; margin-bottom:10px; font-size:12px;">GENERATE AUDIT: RTIS LOCO FILE</div>
    <input type="file" id="locoFile" accept=".csv" style="font-size:12px; margin-bottom:10px;"><br>
    <button onclick="alert('RTIS Logic Connecting...')" style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:4px; font-weight:bold; cursor:pointer; width:100%;">SUBMIT FOR AUDIT</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Setup Map
    const map = L.map('map').setView([21.14, 79.08], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let crewMaster = [];
    let processedLC = new Set();
    const admins = { "CLI_HQ": "hq123", "SR_DEE_OP": "srdee123", "ADEE_OP": "adee123" };

    // 2. Coordinate Conversion
    function conv(v) {
        if(!v) return null;
        let s = v.toString().trim();
        let dot = s.indexOf('.');
        if (dot < 2) return parseFloat(s);
        return parseFloat(s.substring(0, dot-2)) + (parseFloat(s.substring(dot-2))/60);
    }

    // 3. Load Masters (Signals, Stations, Crew)
    function loadMasters() {
        // Load Crew Master for Login [cite: 2026-01-08]
        Papa.parse("master/crew_master.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: r => { crewMaster = r.data; }
        });

        const files = [
            { file: 'master/station.csv', type: 'STN' },
            { file: 'master/up_signals.csv', type: 'UP', clr: 'green' },
            { file: 'master/dn_signals.csv', type: 'DN', clr: 'blue' },
            { file: 'master/up_mid_signals.csv', type: 'UP-M', clr: 'purple' },
            { file: 'master/dn_mid_signals.csv', type: 'DN-M', clr: 'red' }
        ];

        files.forEach(m => {
            Papa.parse(m.file, {
                download: true, header: true, skipEmptyLines: true,
                complete: r => {
                    r.data.forEach(row => {
                        let lat = conv(row.Lat || row.LAT || row.Latitude || row['Start_Lat ']);
                        let lng = conv(row.Lng || row.LNG || row.Longitude || row.Start_Lng);
                        let name = (row.Station_Name || row.Signal_Name || row.SIGNAL_NAME || row.STATION || "").toUpperCase();
                        if(!lat || !lng) return;

                        if(m.type === 'STN') {
                            let eLat = conv(row['End_Lat ']), eLng = conv(row.End_Lng);
                            if(eLat && eLng) L.rectangle([[lat, lng], [eLat, eLng]], {color: 'orange', weight: 2, fillOpacity: 0.2}).addTo(map);
                            L.circleMarker([lat, lng], {radius: 7, color: 'orange', fillOpacity: 1}).addTo(map).bindTooltip(name);
                        } else if(name.includes("L XING") || name.includes("LC")) {
                            let lcId = name.replace(/[^0-9]/g, '');
                            if(!processedLC.has(lcId)) {
                                processedLC.add(lcId);
                                L.marker([lat, lng], { icon: L.divIcon({ className: 'lc-barrier', iconSize: [20, 10] }) }).addTo(map).bindTooltip("LC:"+lcId);
                            }
                        } else if(name.includes("NEU SEC")) {
                            L.marker([lat, lng], { icon: L.divIcon({ html: `<b style="color:#ff00ff; font-size:18px;">âš¡</b>`, iconSize: [15, 15] }) }).addTo(map).bindTooltip(name);
                        } else {
                            L.circleMarker([lat, lng], { radius: 4, color: m.clr, fillOpacity: 0.8 }).addTo(map).bindTooltip(name);
                        }
                    });
                }
            });
        });
    }

    // 4. Login Logic
    function attemptLogin() {
        const id = document.getElementById('uid').value.toUpperCase();
        const pass = document.getElementById('upass').value;
        const err = document.getElementById('loginErr');

        if(admins[id] && admins[id] === pass) {
            success(id);
        } else {
            let found = crewMaster.find(c => (c.CLI_ID || c.CREW_ID) === id);
            if(found && pass === "cli123") {
                success(found.CLI_NAME || found.CREW_NAME);
            } else {
                err.innerText = "Invalid ID or Password!";
            }
        }
    }

    function success(userName) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('upload-panel').style.display = 'block';
        document.getElementById('userDisplay').innerText = userName;
    }

    window.onload = loadMasters;
</script>
</body>
</html>
