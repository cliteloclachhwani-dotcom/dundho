<!DOCTYPE html>
<html>
<head>
    <title>Interactive Audit Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100vw; }
        .lc-gate { border: 2px solid black; background: repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 4px); height: 10px; width: 25px; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    const map = L.map('map').setView([21.14, 79.08], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function conv(v) {
        let s = v.toString();
        let dot = s.indexOf('.');
        return parseFloat(s.substring(0, dot-2)) + (parseFloat(s.substring(dot-2))/60);
    }

    const rawData = localStorage.getItem('rtisData');
    if(rawData) {
        const rtis = Papa.parse(rawData, {header:true}).data;
        let path = [];
        rtis.forEach(row => {
            let lat = conv(row.LATITUDE || row.LAT);
            let lng = conv(row.LONGITUDE || row.LNG);
            if(lat && lng) {
                path.push([lat, lng]);
                let m = L.circleMarker([lat, lng], {radius:3, color: row.SPEED > 0 ? 'blue' : 'red'}).addTo(map);
                m.bindTooltip(`Speed: ${row.SPEED} | Dir: ${row.HEADING || row.COURSE}`);
            }
        });
        L.polyline(path, {color: 'black', weight: 2}).addTo(map);
        map.fitBounds(path);
    }
</script>
</body>
</html>
