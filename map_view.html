<!DOCTYPE html>
<html>
<head>
    <title>SECR - Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100vw; }
        .panel { position: absolute; top: 10px; left: 50px; background: white; padding: 10px; z-index: 1000; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="panel" id="disp">Loading...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const map = L.map('map').setView([21.14, 79.08], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const data = localStorage.getItem('rtis');
        const meta = JSON.parse(localStorage.getItem('meta'));

        if(meta) document.getElementById('disp').innerHTML = `<b>Train:</b> ${meta.train} | <b>LP:</b> ${meta.lp}`;

        if(data) {
            const rows = Papa.parse(data, {header:true}).data;
            let pts = [];
            rows.forEach(r => {
                let lat = parseFloat(r.LATITUDE || r.LAT);
                let lng = parseFloat(r.LONGITUDE || r.LNG);
                if(lat && lng) {
                    pts.push([lat, lng]);
                    let c = L.circleMarker([lat, lng], {radius: 3, color: r.SPEED > 0 ? 'blue' : 'red'}).addTo(map);
                    c.bindTooltip(`Time: ${r.TIME}<br>Speed: ${r.SPEED} kmph`);
                }
            });
            L.polyline(pts, {color: 'black', weight: 2}).addTo(map);
            map.fitBounds(pts);
        }
    </script>
</body>
</html>
